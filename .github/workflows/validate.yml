name: Validate JSON Files

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

jobs:
  validate:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install jsonschema
        
    - name: Validate plugin JSON files
      run: |
        echo "Validating JSON syntax..."
        for file in *.json; do
          if [ -f "$file" ]; then
            echo "Checking $file..."
            python -m json.tool "$file" > /dev/null
            if [ $? -eq 0 ]; then
              echo "  ✓ $file is valid JSON"
            else
              echo "  ✗ $file has invalid JSON syntax"
              exit 1
            fi
          fi
        done
        
    - name: Validate INDEX file
      run: |
        echo "Validating INDEX file against schema..."
        python -c "
import json
import sys

# Load schema
with open('index.schema', 'r') as f:
    schema = json.load(f)

# Load INDEX
with open('INDEX', 'r') as f:
    index = json.load(f)

# Basic validation
print('INDEX file loaded successfully')
print(f'Found {len(index)} plugins in INDEX')

# Verify each entry has required fields
required_fields = ['MANIFEST', 'name', 'icon', 'description', 'official', 'primary_pkg']
for plugin_name, plugin_data in index.items():
    for field in required_fields:
        if field not in plugin_data:
            print(f'✗ Plugin {plugin_name} missing required field: {field}')
            sys.exit(1)
    
    # Verify manifest file exists
    manifest_file = plugin_data['MANIFEST']
    try:
        with open(manifest_file, 'r') as mf:
            manifest = json.load(mf)
            print(f'✓ {plugin_name}: Manifest {manifest_file} is valid')
    except FileNotFoundError:
        print(f'✗ {plugin_name}: Manifest file {manifest_file} not found')
        sys.exit(1)
    except json.JSONDecodeError as e:
        print(f'✗ {plugin_name}: Manifest file {manifest_file} has invalid JSON: {e}')
        sys.exit(1)

print('✓ All plugins in INDEX are valid')
"
        
    - name: Validate plugin manifests
      run: |
        echo "Validating plugin manifest files..."
        python -c "
import json
import sys

# Load INDEX
with open('INDEX', 'r') as f:
    index = json.load(f)

errors = []
for plugin_name, plugin_data in index.items():
    manifest_file = plugin_data['MANIFEST']
    with open(manifest_file, 'r') as mf:
        manifest = json.load(mf)
    
    # Check required manifest fields
    required_manifest_fields = ['name', 'release', 'artifact', 'official']
    for field in required_manifest_fields:
        if field not in manifest:
            errors.append(f'{plugin_name} ({manifest_file}): Missing required field: {field}')
    
    # Verify release version
    if 'release' in manifest:
        release = manifest['release']
        if '13.' not in release:
            print(f'⚠ {plugin_name}: Using release {release} (expected 13.x-RELEASE)')
    
    # Verify artifact URL
    if 'artifact' in manifest:
        artifact = manifest['artifact']
        if not artifact.startswith('https://'):
            print(f'⚠ {plugin_name}: Artifact URL should use HTTPS: {artifact}')

if errors:
    for error in errors:
        print(f'✗ {error}')
    sys.exit(1)
else:
    print('✓ All plugin manifests are valid')
"
